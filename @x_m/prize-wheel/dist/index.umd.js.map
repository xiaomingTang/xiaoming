{"version":3,"file":"index.umd.js","sources":["../src/utils.ts","../src/logic.ts"],"sourcesContent":["import { useState, useEffect } from 'react'\nimport clamp from 'lodash/clamp'\nimport noop from 'lodash/noop'\nimport type { PrizeWheelLogic } from './logic'\n\n/**\n * 缓动函数\n * https://aaron-bird.github.io/2019/03/30/%E7%BC%93%E5%8A%A8%E5%87%BD%E6%95%B0(easing%20function)/\n */\nexport function easeInOutQuad({\n  currentTime,\n  targetTime,\n  startValue,\n  endValue,\n}: {\n  currentTime: number\n  targetTime: number\n  startValue: number\n  endValue: number\n}) {\n  // 归一化 到 0 - 2\n  let normalCurrentTime = clamp(currentTime / (targetTime / 2), 0, 2)\n  const deltaValue = endValue - startValue\n  if (normalCurrentTime < 1) {\n    return startValue + (deltaValue / 2) * normalCurrentTime * normalCurrentTime\n  }\n  normalCurrentTime -= 1\n  return (\n    startValue -\n    (deltaValue / 2) * (normalCurrentTime * (normalCurrentTime - 2) - 1)\n  )\n}\n\nexport function usePrizeWheelState(wheel?: PrizeWheelLogic) {\n  const [deg, setDeg] = useState(-1)\n  const [running, setRunning] = useState(false)\n\n  useEffect(() => {\n    if (!wheel) {\n      return noop\n    }\n    const onStart = () => {\n      setRunning(true)\n    }\n    const onRunning = () => {\n      setDeg(wheel.deg)\n    }\n    const onEnd = () => {\n      setRunning(false)\n    }\n    wheel.addListener('start', onStart)\n    wheel.addListener('running', onRunning)\n    wheel.addListener('end', onEnd)\n    return () => {\n      wheel.removeListener('start', onStart)\n      wheel.removeListener('running', onRunning)\n      wheel.removeListener('end', onEnd)\n    }\n  }, [wheel])\n\n  return {\n    deg,\n    running,\n  }\n}\n","import EventEmitter from '@x_m/event-emitter'\nimport { easeInOutQuad } from './utils'\n\ninterface Options {\n  /**\n   * degree per clock cycle\n   * 表示转动稳定后的速度(度 每 时钟周期)\n   * @default 5\n   */\n  speedRatio?: number\n  /**\n   * 最小转动角度\n   * (不转到该角度不会停, 即使 run 之后立马 shouldStopAtDeg)\n   * @default 3600\n   */\n  minRunningDeg?: number\n  /**\n   * 开始时的缓动角度\n   * (在该角度内慢慢加速至最大速度)\n   * @WARNING 必须大于零(不能等于 0)\n   * @default 540\n   */\n  easeStartDeg?: number\n  /**\n   * 停止时的缓动角度\n   * (在该角度内慢慢减速至目标角度)\n   * @WARNING 必须大于零(不能等于 0)\n   * @default 540\n   */\n  easeStopDeg?: number\n}\n\n/**\n * 幸运大转盘 逻辑部分\n */\nexport class PrizeWheelLogic extends EventEmitter<{\n  start: []\n  running: []\n  end: []\n}> {\n  private rawDeg = -1\n\n  /**\n   * 当前角度\n   */\n  public get deg() {\n    return this.rawDeg\n  }\n\n  // 禁止外部设置 deg 属性\n  private set deg(value: number) {\n    this.rawDeg = value\n    this.emit('running')\n  }\n\n  /**\n   * degree per clock cycle\n   * 表示转动稳定后的速度(度 每 时钟周期)\n   */\n  speedRatio = 5\n\n  /**\n   * 最小转动角度\n   */\n  minRunningDeg = 3600\n\n  /**\n   * 开始时的缓动角度\n   * @WARNING 必须大于零(不能等于 0)\n   */\n  easeStartDeg = 540\n\n  /**\n   * 停止时的缓动角度\n   * @WARNING 必须大于零(不能等于 0)\n   */\n  easeStopDeg = 540\n\n  private rawRunning = false\n\n  /**\n   * 是否正在转动\n   */\n  public get running() {\n    return this.rawRunning\n  }\n\n  // 禁止外部设置 running 属性\n  private set running(value: boolean) {\n    if (value !== this.rawRunning) {\n      this.emit(value ? 'start' : 'end')\n    }\n    this.rawRunning = value\n  }\n\n  /**\n   * 期望停在哪个角度\n   */\n  private shouldStopAtDeg = -1\n\n  constructor(options?: Options) {\n    super()\n    this.easeStartDeg = options?.easeStartDeg ?? this.easeStartDeg\n    this.easeStopDeg = options?.easeStopDeg ?? this.easeStopDeg\n    this.minRunningDeg = options?.minRunningDeg ?? this.minRunningDeg\n    this.speedRatio = options?.speedRatio ?? this.speedRatio\n  }\n\n  /**\n   * 启动大转盘\n   * @WARNING 该方法会重置 shouldStopAtDeg;\n   * 如果你调用了 shouldStopAt 方法后, 继续调用 run 方法,\n   * 会导致前一个 shouldStopAt 方法失效;\n   * (本当如此, 因为你先说停, 后说继续, 那本来就应该继续, 直到下一个 '停')\n   */\n  run() {\n    this.shouldStopAtDeg = -1\n\n    if (!this.running) {\n      this.running = true\n      // deg 复原, 从头开始\n      this.deg = -1\n      this.animate()\n    }\n  }\n\n  /**\n   * 重置\n   */\n  reset() {\n    this.shouldStopAtDeg = -1\n    this.deg = -1\n    this.running = false\n  }\n\n  /**\n   * 外部如需停止转盘, 需要调用 shouldStopAt 方法\n   */\n  private end() {\n    this.running = false\n  }\n\n  /**\n   * 期望停在哪个角度\n   * @param deg 0 - 360\n   */\n  shouldStopAt(deg: number) {\n    // 防止输入有误, 手动限制到 0 - 360\n    const clampedDeg = ((deg % 360) + 360) % 360\n    this.shouldStopAtDeg = Math.max(\n      this.deg + this.easeStopDeg,\n      this.minRunningDeg\n    )\n    const delta = clampedDeg - (this.shouldStopAtDeg % 360)\n    this.shouldStopAtDeg += delta >= 0 ? delta : delta + 360\n  }\n\n  private animate = () => {\n    if (!this.running) {\n      return\n    }\n    let speed: number\n    if (\n      this.shouldStopAtDeg >= 0 &&\n      this.deg - (this.shouldStopAtDeg - this.easeStopDeg) >= 0\n    ) {\n      // 减速至停止\n      speed = easeInOutQuad({\n        currentTime: this.deg - (this.shouldStopAtDeg - this.easeStopDeg),\n        targetTime: this.easeStopDeg,\n        startValue: 1,\n        endValue: 0.1,\n      })\n    } else {\n      // 加速至匀速\n      speed = easeInOutQuad({\n        currentTime: this.deg,\n        targetTime: this.easeStartDeg,\n        startValue: 0.1,\n        endValue: 1,\n      })\n    }\n    this.deg += speed * this.speedRatio\n    if (this.shouldStopAtDeg >= 0) {\n      this.deg = Math.min(this.shouldStopAtDeg, this.deg)\n    }\n    if (this.shouldStopAtDeg < 0 || this.deg < this.shouldStopAtDeg) {\n      window.requestAnimationFrame(this.animate)\n    } else {\n      this.end()\n    }\n  }\n}\n"],"names":["easeInOutQuad","_ref","currentTime","targetTime","startValue","endValue","normalCurrentTime","clamp","deltaValue","usePrizeWheelState","wheel","_useState","useState","_useState2","_slicedToArray","deg","setDeg","_useState4","_useState3","running","setRunning","useEffect","noop","onStart","onRunning","onEnd","addListener","removeListener","PrizeWheelLogic","_EventEmitter","_inherits","_super","_createSuper","options","_options$easeStartDeg","_options$easeStopDeg","_options$minRunningDe","_options$speedRatio","_this","_classCallCheck","_defineProperty","_assertThisInitialized","speed","shouldStopAtDeg","easeStopDeg","easeStartDeg","speedRatio","Math","min","window","requestAnimationFrame","animate","end","minRunningDeg","_createClass","rawDeg","value","emit","rawRunning","clampedDeg","max","delta","EventEmitter"],"mappings":"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"}