{"version":3,"file":"index.es.js","sources":["../src/utils.ts","../src/logic.ts"],"sourcesContent":["import { useState, useEffect } from 'react'\nimport { clamp, noop } from 'lodash-es'\nimport type { PrizeWheelLogic } from './logic'\n\n/**\n * 缓动函数\n * https://aaron-bird.github.io/2019/03/30/%E7%BC%93%E5%8A%A8%E5%87%BD%E6%95%B0(easing%20function)/\n */\nexport function easeInOutQuad({\n  currentTime,\n  targetTime,\n  startValue,\n  endValue,\n}: {\n  currentTime: number\n  targetTime: number\n  startValue: number\n  endValue: number\n}) {\n  // 归一化 到 0 - 2\n  let normalCurrentTime = clamp(currentTime / (targetTime / 2), 0, 2)\n  const deltaValue = endValue - startValue\n  if (normalCurrentTime < 1) {\n    return startValue + (deltaValue / 2) * normalCurrentTime * normalCurrentTime\n  }\n  normalCurrentTime -= 1\n  return (\n    startValue -\n    (deltaValue / 2) * (normalCurrentTime * (normalCurrentTime - 2) - 1)\n  )\n}\n\nexport function usePrizeWheelState(wheel?: PrizeWheelLogic) {\n  const [deg, setDeg] = useState(-1)\n  const [running, setRunning] = useState(false)\n\n  useEffect(() => {\n    if (!wheel) {\n      return noop\n    }\n    const onStart = () => {\n      setRunning(true)\n    }\n    const onRunning = () => {\n      setDeg(wheel.deg)\n    }\n    const onEnd = () => {\n      setRunning(false)\n    }\n    wheel.addListener('start', onStart)\n    wheel.addListener('running', onRunning)\n    wheel.addListener('end', onEnd)\n    return () => {\n      wheel.removeListener('start', onStart)\n      wheel.removeListener('running', onRunning)\n      wheel.removeListener('end', onEnd)\n    }\n  }, [wheel])\n\n  return {\n    deg,\n    running,\n  }\n}\n","import EventEmitter from '@x_m/event-emitter'\nimport { easeInOutQuad } from './utils'\n\ninterface Options {\n  /**\n   * degree per clock cycle\n   * 表示转动稳定后的速度(度 每 时钟周期)\n   * @default 5\n   */\n  speedRatio?: number\n  /**\n   * 最小转动角度\n   * (不转到该角度不会停, 即使 run 之后立马 shouldStopAtDeg)\n   * @default 3600\n   */\n  minRunningDeg?: number\n  /**\n   * 开始时的缓动角度\n   * (在该角度内慢慢加速至最大速度)\n   * @WARNING 必须大于零(不能等于 0)\n   * @default 540\n   */\n  easeStartDeg?: number\n  /**\n   * 停止时的缓动角度\n   * (在该角度内慢慢减速至目标角度)\n   * @WARNING 必须大于零(不能等于 0)\n   * @default 540\n   */\n  easeStopDeg?: number\n}\n\n/**\n * 幸运大转盘 逻辑部分\n */\nexport class PrizeWheelLogic extends EventEmitter<{\n  start: []\n  running: []\n  end: []\n}> {\n  private rawDeg = -1\n\n  /**\n   * 当前角度\n   */\n  public get deg() {\n    return this.rawDeg\n  }\n\n  // 禁止外部设置 deg 属性\n  private set deg(value: number) {\n    this.rawDeg = value\n    this.emit('running')\n  }\n\n  /**\n   * degree per clock cycle\n   * 表示转动稳定后的速度(度 每 时钟周期)\n   */\n  speedRatio = 5\n\n  /**\n   * 最小转动角度\n   */\n  minRunningDeg = 3600\n\n  /**\n   * 开始时的缓动角度\n   * @WARNING 必须大于零(不能等于 0)\n   */\n  easeStartDeg = 540\n\n  /**\n   * 停止时的缓动角度\n   * @WARNING 必须大于零(不能等于 0)\n   */\n  easeStopDeg = 540\n\n  private rawRunning = false\n\n  /**\n   * 是否正在转动\n   */\n  public get running() {\n    return this.rawRunning\n  }\n\n  // 禁止外部设置 running 属性\n  private set running(value: boolean) {\n    if (value !== this.rawRunning) {\n      this.emit(value ? 'start' : 'end')\n    }\n    this.rawRunning = value\n  }\n\n  /**\n   * 期望停在哪个角度\n   */\n  private shouldStopAtDeg = -1\n\n  constructor(options?: Options) {\n    super()\n    this.easeStartDeg = options?.easeStartDeg ?? this.easeStartDeg\n    this.easeStopDeg = options?.easeStopDeg ?? this.easeStopDeg\n    this.minRunningDeg = options?.minRunningDeg ?? this.minRunningDeg\n    this.speedRatio = options?.speedRatio ?? this.speedRatio\n  }\n\n  /**\n   * 启动大转盘\n   * @WARNING 该方法会重置 shouldStopAtDeg;\n   * 如果你调用了 shouldStopAt 方法后, 继续调用 run 方法,\n   * 会导致前一个 shouldStopAt 方法失效;\n   * (本当如此, 因为你先说停, 后说继续, 那本来就应该继续, 直到下一个 '停')\n   */\n  run() {\n    this.shouldStopAtDeg = -1\n\n    if (!this.running) {\n      this.running = true\n      // deg 复原, 从头开始\n      this.deg = -1\n      this.animate()\n    }\n  }\n\n  /**\n   * 重置\n   */\n  reset() {\n    this.shouldStopAtDeg = -1\n    this.deg = -1\n    this.running = false\n  }\n\n  /**\n   * 外部如需停止转盘, 需要调用 shouldStopAt 方法\n   */\n  private end() {\n    this.running = false\n  }\n\n  /**\n   * 期望停在哪个角度\n   * @param deg 0 - 360\n   */\n  shouldStopAt(deg: number) {\n    // 防止输入有误, 手动限制到 0 - 360\n    const clampedDeg = ((deg % 360) + 360) % 360\n    this.shouldStopAtDeg = Math.max(\n      this.deg + this.easeStopDeg,\n      this.minRunningDeg\n    )\n    const delta = clampedDeg - (this.shouldStopAtDeg % 360)\n    this.shouldStopAtDeg += delta >= 0 ? delta : delta + 360\n  }\n\n  private animate = () => {\n    if (!this.running) {\n      return\n    }\n    let speed: number\n    if (\n      this.shouldStopAtDeg >= 0 &&\n      this.deg - (this.shouldStopAtDeg - this.easeStopDeg) >= 0\n    ) {\n      // 减速至停止\n      speed = easeInOutQuad({\n        currentTime: this.deg - (this.shouldStopAtDeg - this.easeStopDeg),\n        targetTime: this.easeStopDeg,\n        startValue: 1,\n        endValue: 0.1,\n      })\n    } else {\n      // 加速至匀速\n      speed = easeInOutQuad({\n        currentTime: this.deg,\n        targetTime: this.easeStartDeg,\n        startValue: 0.1,\n        endValue: 1,\n      })\n    }\n    this.deg += speed * this.speedRatio\n    if (this.shouldStopAtDeg >= 0) {\n      this.deg = Math.min(this.shouldStopAtDeg, this.deg)\n    }\n    if (this.shouldStopAtDeg < 0 || this.deg < this.shouldStopAtDeg) {\n      window.requestAnimationFrame(this.animate)\n    } else {\n      this.end()\n    }\n  }\n}\n"],"names":["easeInOutQuad","_ref","currentTime","targetTime","startValue","endValue","normalCurrentTime","clamp","deltaValue","usePrizeWheelState","wheel","_useState","useState","_useState2","_slicedToArray","deg","setDeg","_useState4","_useState3","running","setRunning","useEffect","noop","onStart","onRunning","onEnd","addListener","removeListener","PrizeWheelLogic","_EventEmitter","_inherits","_super","_createSuper","options","_options$easeStartDeg","_options$easeStopDeg","_options$minRunningDe","_options$speedRatio","_this","_classCallCheck","_defineProperty","_assertThisInitialized","speed","shouldStopAtDeg","easeStopDeg","easeStartDeg","speedRatio","Math","min","window","requestAnimationFrame","animate","end","minRunningDeg","_createClass","rawDeg","value","emit","rawRunning","clampedDeg","max","delta","EventEmitter"],"mappings":"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"}